<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sMAP Tags Utility</title>
    <link href="/media/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="/media/smap/css/vquery.css" rel="stylesheet" media="screen">
    <link href="/media/smap/css/status.css" rel="stylesheet" media="screen">
    <link rel="stylesheet" type="text/css" href="//ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-migrate/1.1.1/jquery-migrate.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/datatables/1.9.4/jquery.dataTables.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
    <script src="/media/smap/js/vquery.js"></script>

    <style type='text/css'>
    #metadata-inside { 
        background: rgb(245, 245, 245);
        border-radius:4px;
        padding: 8px;
        border-width: 1px;
        border-style: solid;
        border-color:rgba(0, 0, 0, 0.148438);
        margin-bottom: 5px;
    }
    </style>
  </head>

  <body>
    <div class="main">
      <div class="left">
        <div id="vquery"></div>
        <div id='stream-div' style="height: 90%; overflow: auto; margin-top:10px;"></div>
      </div> 

      <div class="right" style="height: 100%;">
        <div id="paths-cont">
          Selected paths
          <pre id="paths" class="prettyprint"></pre>
        </div>
        <div id="metadata-cont">
          Common metadata
          <pre id="common-metadata" class="prettyprint"></pre>
        </div>
        <div id="single-stream-metadata-cont" style="display:none">
          Stream metadata
          <pre id="single-stream-metadata" class="prettyprint"></pre>
        </div>
        <div id="edit-metadata">
          Add or edit tags 
          <div id="metadata-inside">
            <input id="metadata-tag" class="typeahead" style="margin-top:9px;" type="text"> =
            <input id="metadata-val" style="margin-top:9px;" type="text">
            <button class="btn" id="metadata-set">set</button>
          </div>
        </div>
      </div>

      <div id="confirm" class="modal hide">
        <div id="confirm-body" class="modal-body"></div>
        <div class="modal-footer">
          <button type="button" data-dismiss="modal" class="btn">Nevermind</button>
          <button type="button" id="modal-confirm" class="btn btn-primary">Confirm</button>
        </div>
      </div>

    </div>

    <script>
      var enum_id = 1;
      var url = "/backend/api/query";
      function intersect_json(o){
        // find common metadata recursively
        var ks = []
        _.each(o, function(el){
          ks.push(_.keys(el))
        });
        ks = _.uniq(_.flatten(ks))
        var r = {}
        _.each(ks, function(k){
          vs = _.uniq(_.pluck(o, k))
          if (typeof vs[0] == "object") {
            var r_rec = intersect_json(vs)
            if (!$.isEmptyObject(r_rec)) {
              r[k] = r_rec  
            }
          } else if (vs.length == 1){
            r[k] = vs[0]
          }
        });
        return r
      }

      function genStreamTable(data){
        var html, row = '';
        data.forEach(function(d){
          try{
            var _date = new Date(d.Readings[0][0]);
            var _reading = d.Readings[0][1].toFixed(2);
          }catch(err){}
          row = "<tr class='stream-row' data-uuid='" + d.uuid + "'>";
          row += "<td class='path'>" + d.Path + "</td>";
          row += "<td class='reading'>" + _reading + "</td>";
          row += "<td class='timestamp'>" + _date + "</td>";
          row += "</tr>";
          html += row; 
        });
        return html;
      }

      function renderPaths(paths){
        paths = paths.join('\n')
        $("#paths").html(paths)
      }

      function renderCommonMetadata(uuids){
        if (uuids.length > 0){
          var where = "uuid='" + uuids.join("' or uuid='") + "'"
          var query = "select * where " + where
          console.log(query)
          $.ajax({
            url: url,
            type: "post",
            data: query,
            success: function(res){
              var m = intersect_json(res)
              $('#common-metadata').empty();
              if (!$.isEmptyObject(m)){
                m = JSON.stringify(m, null, 4);
                $('#common-metadata').html(m);
              }
            }
          });
          } else {
            $('#common-metadata').empty();
          }
      }

      function renderStreamMetadata(uuid){
        var query = "select * where uuid='" + uuid + "'";
        $.ajax({
          url: url,
          type: "post",
          data: query,
          success: function(res){
            var m = res[0]
            $('#single-stream-metadata').empty();
            if (!$.isEmptyObject(m)){
              m = JSON.stringify(m, null, 4);
              $('#single-stream-metadata').html(m);
            }
          }
        });
      }
  
      var vqCallback = function(data){
        var html = genStreamTable(data);
        var viewportHeight = $(window).height();
        var vqueryHeight = $('#vquery').outerHeight();
        $('#stream-div').height(viewportHeight-vqueryHeight-20);
        $('#datatable').remove();
        $('#stream-div').append(' \
          <table id="datatable" class="table table-compact table-bordered"> \
            <thead> \
              <tr> \
                <th>Path</th> \
                <th>current value</th> \
                <th>local time</th> \
              </tr> \
            </thead> \
          <tbody id="streams"></tbody> \
          </table>');
        $('#streams').html(html);
        var dtable = $('#datatable').dataTable({
          "bProcessing": true,
          "bFilter": false,
          "bPaginate": false
        });
        $('#datatable_info').remove();
        
        $('.stream-row').mouseover(function(){
          var uuid = $(this).data("uuid");
          renderStreamMetadata(uuid);
        });

        $('.stream-row').click(function(){
          $(this).toggleClass("selected");     
          var paths_uuids = getSelectedPathsUuids();
          renderPaths(paths_uuids.paths);
          renderCommonMetadata(paths_uuids.uuids);
        });
      }

      function getSelectedPathsUuids(){
        var selected = $(".selected")
        var paths = _.map(selected, function(el){
          var path = el.cells[0].innerHTML
          return path
        });
        var uuids = _.map(selected, function(el){
          var uuid = el.getAttribute('data-uuid')
          return uuid
        });
        return {'paths': paths, 'uuids': uuids}
      }

      new VQuery(url, vqCallback);

      $('#stream-div').hover(function(){
        $('#metadata-cont').hide();
        $('#single-stream-metadata-cont').fadeIn(400);
      },
      function(){
        $('#single-stream-metadata-cont').hide();
        $('#metadata-cont').fadeIn(400);
        $('#single-stream-metadata').empty();
      });

      $('#metadata-set').click(function(){
        var paths_uuids = getSelectedPathsUuids(); 
        var uuids = paths_uuids.uuids;
        var paths = paths_uuids.paths;
        var where = "uuid='" + uuids.join("' or uuid='") + "'";
        var tag = $('#metadata-tag').val();
        var val = $('#metadata-val').val();
        var query = "set " + tag + "='" + val + "' where " + where;
        console.log(query)
        $('#confirm').modal();
        var conf_str = "Setting <code>" + tag + "='" + val + "'</code> for streams with the following paths: <br>";
        $('#modal-confirm').click(function(){
          $.ajax({
            url: url,
            type: "post",
            data: query,
            success: function(res){
              $('#confirm').modal('hide');
              $('#edit-metadata').append('<div class="alert alert-success"> \
                  <strong>Success:</strong> Tags have been set. \
                </div>');
              renderCommonMetadata(uuids);
              $(".alert").delay(5000).fadeOut("slow");
            },
            error: function(err){
              $('#edit-metadata').append('<div class="alert alert-success fade"> \
                  <strong>Failure:</strong>' + err + '. \
                </div>');
              $(".alert").delay(5000).fadeOut("slow");
            }
          });
        });
        $('#confirm-body').html(conf_str + "<br><pre>" + paths.join('\n') + "</pre>");
      });

    </script>
  </body>
</html>
